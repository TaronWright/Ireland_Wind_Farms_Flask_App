<!-- templates/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wind Farm Map</title>
    <link href="{{url_for('static',filename='css/main.css')}}" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     <!-- Turf CDN-->
     <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
     <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <!-- Include Chartjs via CDN-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        #map { height:100%; 
        }

        body {
            height: 100vh; /* Ensure the body takes the full height of the viewport */
            width: 100%; /* Ensure the body takes the full width of the viewport */
        }
        .container {
            display: grid;
            grid-template-rows: repeat(10, 1fr); /* Split into four rows */
            grid-template-columns: repeat(10, 1fr);
            gap: 25px;
            max-width: 100%; /* Set to 100% to take up full width of the viewport */
            /* width: 100vw; Ensure the container takes the full width of the viewport */
            height: 100%; /* Ensure the container takes the full height of the viewport */
        }

        .container > div {
            background-color: white;
            border-radius: 25px;
            box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;
        } 

        .header {
            display: block;
        }

        .map {
            grid-row: 4/11;
            grid-column: 1/4;
        }
        
        
        .turbineDetails{
            grid-row: 4/11;
            grid-column: 4/6;
        }

        .chart{
            grid-row: 4/11;
            grid-column: 6/11;
        }

        canvas {
            /* Additional styles for the content inside grid items */
            max-width: 100%; /* Ensure content doesn't exceed the width of the grid item */
            max-height: 100%; /* Ensure content doesn't exceed the height of the grid item */
        }
        .card1{
            grid-row: 1/4;
            grid-column: 2/4;
        }

        .card2{
            grid-row: 1/4;
            grid-column: 5/7;
        }

        .card3{
            grid-row: 1/4;
            grid-column: 8/10;
        }

        .detailsContainer {
            display: grid;
            grid-template-rows: repeat(10,  minmax(0, 1fr)); /* Split into ten rows */
            grid-template-columns: repeat(2, 1fr);
            column-gap: 25px;
            margin: 10px;
            max-width: 100%; /* Set to 100% to take up full width of the viewport */
            /* width: 100vw; Ensure the container takes the full width of the viewport */
            height: 100%; /* Ensure the container takes the full height of the viewport */
        }

        .detailsContainer > div {
            align-self: center;
            justify-self: center;
            font-size: 11px;
            font-weight: bold;
        }
    </style>
<body>
<!-- <div class="header"><h1>Wind Farms Map</h1></div> -->
<div class="container">
    <div class="card1"></div>
    <div class="card2"></div>
    <div class="card3"></div>
    <div class="map" id="map"></div>
    <!-- Radio buttons for data selection -->
    <div class="turbineDetails">
        <div class = "detailsContainer">
                <div>Windfarm Name:</div>
                <div class="windfarmname"></div>

                <div>Number of turbines:</div>
                <div class="numberturbines"></div>

                <div>Rotor Diameter:</div>
                <div class="rotordiameter"></div>

                <div>Minimum hub height:</div>
                <div class="minhubheight"></div>

                <div>Maximum hub height:</div>
                <div class="maxhubheight"></div>
 
                <div>Cut-in wind speed:</div>
                <div class="cutinspeed"></div>

                <div>Cut-off wind speed:</div>
                <div class="cutoffspeed"></div>

                <div>Rated wind speed:</div>
                <div class="ratedspeed"></div>

                <div>Rated power:</div>
                <div class="ratedpower"></div>

                <div>Manufacturer:</div>
                <div class="manufacturer"></div>
        </div>
    </div>
    <div class="chart">
        <div class="buttons"> 
            <label>
                <input type="radio" name="dataSet" value="Windspeeds"> Wind Speed
            </label>
            <label>
                <input type="radio" name="dataSet" value="Windpowers" checked> Wind Power
            </label>
        </div>
        <canvas class="h-full w-full" id="windChart"></canvas>
    </div>
</div>
    

   


<script>
    //data block 
    data = {
            labels: [],
            datasets: [{
                label: 'My Chart',
                data: [],
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                fill: false
            }]
        }
    // config 
    const config = {
      type: 'line',
      data,
      options: {
            scales: {
                x: {
                    type: 'time',
                    time: {
                            unit: 'day',
                    },
                    min: Date(),
                    max: Date()
                }
            }
        }
    };
    // render init block
    let windChart = new Chart(
      document.getElementById('windChart'),
      config
    );
</script>

<script>
    //Set the map with center of London
    let map = L.map('map').setView([52.505, -7.09], 7);

    //Set the tile layer of the map using openstreetmap
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    //Set a onclick function for the map to capture user click coordinates
    let popup = L.popup();
    
    //Set all windfarm location markers
    windfarm_data = {{windfarm_data | safe}}

    // Loop through all windfarms and add a marker on the map for each
    for (let i = 0; i < windfarm_data.length; i++){
        tableHtml = `
        <table>
            <tr>
                <div>Windfarm Name</div>
                <div>${windfarm_data[i]["Wind Farm Name"]}</div>
            </tr>
            <tr>
                <div>Minimum hub height</div>
                <div>${windfarm_data[i]["Minimum hub height"]}</div>
            </tr>
            <tr>
                <div>Maximum hub height</div>
                <div>${windfarm_data[i]["Maximum hub height"]}</div>
            </tr>
            <tr>
                <div>Cut-in wind speed</div>
                <div>${windfarm_data[i]["Cut-in wind speed"]}</div>
            </tr>
            <tr>
                <div>Cut-off wind speed</div>
                <div>${windfarm_data[i]["Cut-off wind speed"]}</div>
            </tr>
            <tr>
                <div>Rated wind speed</div>
                <div>${windfarm_data[i]["Rated wind speed"]}</div>
            </tr>
            <tr>
                <div>Rated power</div>
                <div>${windfarm_data[i]["Rated power"]}</div>
            </tr>
            <tr>
                <div>Manufacturer</div>
                <div>${windfarm_data[i]["Manufacturer"]}</div>
            </tr>
        </table> `;
        marker = new L.marker([windfarm_data[i]['Latitude'], windfarm_data[i]['Longitude']])
        //Bind Popup text to the Wind Farm Name which then is used by the onclick event to retrieve that wind farm's data from the server
        .bindPopup(windfarm_data[i]['Wind Farm Name'])
        .addTo(map)
        .on("click", clickMarker); };

    // Set values in global scope
    let timestamp_values;
    let windspeed_values;
    let windpower_values;
    // Function for clicking on map markers that makes call to the server for the windspeed data for that windfarm
    function clickMarker(e) {
        // Set to empty array on every click so values do not stack
        timestamp_values = [];
        windspeed_values = [];
        windpower_values = [];
        console.log(e)
        // Set windfarm name to the popup content
        let windfarmName = e.target._popup._content
        //Set url to the url for the lookup route on flask server-side
        let lookup_url = {{ url_for('lookup')|tojson }} 
        //Set data to be posted to flask api
        let data = {"Windfarm": windfarmName}
        // fetch post request with data
        fetch(lookup_url, {
        "method": "POST",
        "headers": {"Content-Type": "application/json"},
        "body": JSON.stringify(data),
         })
        .then(function(response){
            return response.json();
        })
        .then(function(json){
            // Loop through the objects returned by server to get each object data and then add timestamps and windspeeds to an array
            for (const element of json) {
                timestamp_values.push(element['timestamp']['$date']);
                console.log(element['windspeed'])
                windspeed_values.push(element['windspeed']);
                windpower_values.push(element.windpower);
            };
            // Populate windChart x and y values with data 
            windChart.data.labels = timestamp_values
            windChart.data.datasets[0].data = windspeed_values

            // Update the windchart with the new data rather than adding another layer everytime function is called
            updateChartData(windspeed_values, windpower_values) 
        })
        //Set url to the url for the windturbine detials route on flask server-side
        lookup_url = {{ url_for('windfarm_details')|tojson }} 
        fetch(lookup_url, {
        "method": "POST",
        "headers": {"Content-Type": "application/json"},
        "body": JSON.stringify(data),
         })
        .then(function(response){
            return response.json();
        }).then(function(json){
            if (json[0]['Wind Farm Name'] != null ){
                document.querySelector('.windfarmname').textContent = json[0]['Wind Farm Name']
            } else{
                document.querySelector('.windfarmname').textContent = "N/A"
            }
            if (json[0]['Number of Turbines'] != null ){
                document.querySelector('.numberturbines').textContent = json[0]['Number of Turbines']
            } else{
                document.querySelector('.numberturbines').textContent = "N/A"
            }
            if (json[0]['Rotor diameter'] != null ){
                document.querySelector('.rotordiameter').textContent  = json[0]['Rotor diameter'] + "m"
            } else{
                document.querySelector('.rotordiameter').textContent = "N/A"
            }
            if (json[0]['Minimum hub height']  != null ){
                document.querySelector('.minhubheight').textContent  = json[0]['Minimum hub height'] + "m"
            } else{
                document.querySelector('.minhubheight').textContent = "N/A"
            }
            if (json[0]['Maximum hub height']  != null ){
                document.querySelector('.maxhubheight').textContent = json[0]['Maximum hub height'] + "m"
            } else{
                document.querySelector('.maxhubheight').textContent = "N/A"
            }
            if (json[0]['Cut-in wind speed']  != null ){
                document.querySelector('.cutinspeed').textContent = json[0]['Cut-in wind speed']  +"m/s"
            } else{
                document.querySelector('.cutinspeed').textContent = "N/A"
            }
            if (json[0]['Cut-off wind speed']  != null ){
                document.querySelector('.cutoffspeed').textContent = json[0]['Cut-off wind speed'] + "m/s"
            } else{
                document.querySelector('.cutoffspeed').textContent = "N/A"
            }
            if (json[0]['Rated wind speed']  != null ){
                document.querySelector('.ratedspeed').textContent = json[0]['Rated wind speed'] + "m/s"
            } else{
                document.querySelector('.ratedspeed').textContent = "N/A"
            }
            if (json[0]['Rated power']   != null ){
                document.querySelector('.ratedpower').textContent = json[0]['Rated power'] + "W"
            } else{
                document.querySelector('.ratedpower').textContent = "N/A"
            }
            if (json[0]['Manufacturer']  != null ){
                document.querySelector('.manufacturer').textContent = json[0]['Manufacturer']
            } else{
                document.querySelector('.manufacturer').textContent = "N/A"
            }
        }
        )
    };

        // Function to update chart data based on selected radio button
        function updateChartData(windspeeds, windpowers) {
        let selectedDataSet = document.querySelector('input[name="dataSet"]:checked').value;

        if (selectedDataSet === 'Windspeeds') {
            windChart.data.datasets[0].data = windspeeds;
            windChart.data.datasets[0].label = 'Wind Speed';
        } else if (selectedDataSet === 'Windpowers') {
            windChart.data.datasets[0].data = windpowers;
            windChart.data.datasets[0].label = 'Wind Power';
        }

        // Update the windchart with the new data rather than adding another layer everytime function is called
        windChart.update();

        
    }
    // // Add event listener to radio buttons
    let radioButtons = document.querySelectorAll('input[name="dataSet"]');
    radioButtons.forEach(function (radioButton) {
    // Reference function pass to addEventlistener
    radioButton.addEventListener('change', function() {updateChartData(windspeed_values, windpower_values)} )
    });
    
</script>

<script>
     async function getChoropleth(){
        let choropleth_url = {{ url_for('choropleth')|tojson }};
        const response = await fetch(choropleth_url)
        const choropleth_json = await response.json()
        console.log(choropleth_json['features'])
        // Perform the point-in-polygon check
        for (let i = 0; i < windfarm_data.length; i++){
            console.log([windfarm_data[i]['Longitude'],windfarm_data[i]['Latitude']])
            for (let j = 0; j < choropleth_json['features'].length; j++){
                console.log(choropleth_json['features'][j]['properties']['ENGLISH'])
                let isPointInside = turf.booleanPointInPolygon([windfarm_data[i]['Longitude'],windfarm_data[i]['Latitude']], choropleth_json['features'][j].geometry);
                console.log(isPointInside)
                    if (isPointInside) {
                        console.log("Worked");

                        break;
    
                    }
            }
            
        }
            L.geoJson(choropleth_json).addTo(map);
            console.log(choropleth_json)
    }
</script>

</body>
</html>